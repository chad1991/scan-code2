<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üì∑ Barcode Scanner Logsheet</title>

  <!-- Quagga (1D) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <!-- ZXing (2D/QR & many formats) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 12px; background:#f6f7fb; color:#222; }
    h2 { margin: 0 0 8px 0; }
    #cameraPreview {
      width: 360px; height: 270px; border-radius:8px; border:3px solid #333;
      background:black; display:block; margin:12px auto;
      object-fit: cover;
    }
    .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:12px; }
    .controls button, .controls select { padding:8px 10px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer; }
    #manualForm { margin:10px auto; padding:10px; border-radius:8px; background:white; width:100%; max-width:760px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    #manualForm input { padding:6px; margin:4px; }
    #logTable { width:100%; max-width:760px; margin:12px auto; border-collapse:collapse; background:white; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    #logTable th, #logTable td { border:1px solid #e6e6e6; padding:8px; text-align:center; }
    #batchesList, #entriesList { list-style:none; padding:0; margin:8px 0; max-width:760px; margin-left:auto; margin-right:auto; }
    #batchesList li { background:#eef; padding:8px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    .small-btn { padding:6px 8px; border-radius:6px; border:0; cursor:pointer; }
    .danger { background:#ff6b6b; color:white; }
    .primary { background:#3478f6; color:white; }
    .muted { background:#f0f0f0; color:#333; }
    #result { text-align:center; font-weight:600; margin-top:6px; }
  </style>

  <!-- In-app browser notice (Messenger / Instagram) -->
  <script>
    function isInAppBrowser(){
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      return (/FBAN|FBAV|Instagram/i).test(ua);
    }
    window.addEventListener('load', () => {
      if (isInAppBrowser()) {
        const notice = document.createElement('div');
        notice.style = 'position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center';
        notice.innerHTML = `
          <h2>‚ö†Ô∏è Open in Chrome for best experience</h2>
          <p>Messenger/Instagram uses an in-app browser that may block the camera or downloads.<br>Tap below to open in Chrome.</p>
          <a id="openChrome" style="display:inline-block;margin-top:12px;padding:12px 18px;border-radius:8px;background:#4285f4;color:#fff;text-decoration:none;">üöÄ Open in Chrome</a>
        `;
        document.body.appendChild(notice);
        document.getElementById('openChrome').addEventListener('click', () => {
          // open using intent scheme (best-effort)
          window.location.href = "intent://" + location.hostname + location.pathname + "#Intent;scheme=https;package=com.android.chrome;end";
        });
      }
    });
  </script>
</head>
<body>
  <h2>üì∑ Barcode Scanner Logsheet</h2>

  <!-- Camera preview -->
  <video id="cameraPreview" autoplay playsinline muted></video>
  <div id="result">Ready to scan</div>

  <!-- Scan Mode controls -->
  <div class="controls">
    <label>
      <strong>Scan Mode:&nbsp;</strong>
      <select id="scanModeSelect" onchange="switchMode(this.value)">
        <option value="1d">1D Only</option>
        <option value="2d">2D Only</option>
        <option value="all">All (best)</option>
      </select>
    </label>

    <button class="primary" onclick="startScanner()">‚ñ∂Ô∏è Start</button>
    <button onclick="stopScanner()">‚èπ Stop</button>
    <button onclick="toggleCamera()">üîÑ Toggle Camera</button>
    <button onclick="downloadExcel()">üíæ Save Excel</button>
    <button class="danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
    <button onclick="nextBatch()">‚û°Ô∏è Next Batch</button>
  </div>

  <!-- Batch header included from header.html -->
  <div id="headerInclude" style="text-align:center;"></div>

  <!-- Manual entry -->
  <div id="manualForm">
    <strong>‚úçÔ∏è Manual Entry</strong><br>
    <input id="manualBarcode" placeholder="Barcode" type="text">
    <input id="manualQty" placeholder="Qty" type="number" min="1" value="1">
    <input id="manualPrice" placeholder="Price" type="number" step="0.01" min="0">
    <button class="primary" onclick="addManual()">Add</button>
  </div>

  <!-- Log table -->
  <table id="logTable">
    <thead>
      <tr><th>Barcode</th><th>Qty</th><th>Price</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 style="text-align:center;margin-top:16px;">üì¶ Saved Batches</h3>
  <ul id="batchesList"></ul>

  <!-- sounds -->
  <audio id="beepSuccess" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="beepError" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script src="script.js"></script>
  <script>
    // load header.html and restore header fields
    fetch('header.html').then(r => r.text()).then(html => {
      document.getElementById('headerInclude').innerHTML = html;
      restoreHeader();
    });

    // restore scan mode
    document.getElementById('scanModeSelect').value = localStorage.getItem('scanMode') || 'all';
  </script>
</body>
</html>
